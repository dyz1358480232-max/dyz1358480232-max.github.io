<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新闻创作者平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .editor-toolbar button:hover {
            @apply bg-blue-100;
        }
        .news-item:hover {
            @apply shadow-lg transform -translate-y-1 transition-all;
        }
        #contentEditor:empty:before {
            content: '请输入新闻内容（必填，支持图文混排）';
            color: #9ca3af;
            pointer-events: none;
        }
        #contentEditor {
            outline: none;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600">新闻创作者平台</h1>
            <p class="text-gray-500">发布新闻，实时同步到读者端</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">发布新闻</h2>
                
                <!-- 分类选择 -->
                <select id="newsCategory" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="家居">家居</option>
                    <option value="运动">运动</option>
                    <option value="商业">商业</option>
                    <option value="创新">创新</option>
                    <option value="文化">文化</option>
                    <option value="艺术">艺术</option>
                    <option value="旅行">旅行</option>
                    <option value="地球">地球</option>
                </select>
                
                <input 
                    type="text" 
                    id="newsTitle" 
                    placeholder="请输入新闻标题（必填）" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                
                <div class="editor-toolbar flex gap-2 mb-4 px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
                    <button id="boldBtn" class="px-3 py-1 border border-gray-300 rounded hover:cursor-pointer">
                        <b>B</b>
                    </button>
                    <button id="italicBtn" class="px-3 py-1 border border-gray-300 rounded hover:cursor-pointer">
                        <i>I</i>
                    </button>
                    <button id="fontSizeBtn" class="px-3 py-1 border border-gray-300 rounded hover:cursor-pointer">
                        Aa
                    </button>
                    <div class="h-6 w-px bg-gray-300 mx-1"></div>
                    <label for="imageUpload" class="px-3 py-1 bg-blue-500 text-white rounded hover:cursor-pointer">
                        上传图片
                    </label>
                    <input type="file" id="imageUpload" accept="image/*" class="hidden">
                    <span id="uploadStatus" class="ml-2 text-sm text-gray-500"></span>
                </div>
                
                <div 
                    id="contentEditor" 
                    contenteditable="true" 
                    class="w-full min-h-[300px] px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                ></div>
                
                <button id="publishBtn" class="mt-6 w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    发布新闻
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">已发布新闻</h2>
                <div id="newsList" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
                    <p class="text-gray-500 text-center py-8">暂无已发布新闻</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        let newsData = JSON.parse(localStorage.getItem('newsData')) || [];

        // DOM元素获取
        const newsCategory = document.getElementById('newsCategory');
        const newsTitle = document.getElementById('newsTitle');
        const contentEditor = document.getElementById('contentEditor');
        const boldBtn = document.getElementById('boldBtn');
        const italicBtn = document.getElementById('italicBtn');
        const fontSizeBtn = document.getElementById('fontSizeBtn');
        const imageUpload = document.getElementById('imageUpload');
        const uploadStatus = document.getElementById('uploadStatus');
        const publishBtn = document.getElementById('publishBtn');
        const newsList = document.getElementById('newsList');

        // 富文本编辑功能
        boldBtn.addEventListener('click', () => {
            applyFormat('bold');
            contentEditor.focus();
        });
        italicBtn.addEventListener('click', () => {
            applyFormat('italic');
            contentEditor.focus();
        });
        fontSizeBtn.addEventListener('click', () => {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            
            const range = selection.getRangeAt(0);
            const selectedContent = range.extractContents();
            
            const span = document.createElement('span');
            const currentSize = parseInt(window.getComputedStyle(selectedContent.firstChild || span).fontSize) || 16;
            const newSize = currentSize === 16 ? 20 : currentSize === 20 ? 24 : 16;
            span.style.fontSize = `${newSize}px`;
            
            span.appendChild(selectedContent);
            range.insertNode(span);
            range.selectNodeContents(span);
            selection.removeAllRanges();
            selection.addRange(range);
            
            contentEditor.focus();
        });

        // 图片上传功能（核心修复：确保图片Base64完整存储）
        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                uploadStatus.textContent = '❌ 请上传图片文件（jpg/png/gif）';
                uploadStatus.classList.add('text-red-500');
                setTimeout(() => {
                    uploadStatus.textContent = '';
                    uploadStatus.classList.remove('text-red-500');
                }, 3000);
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                // 核心：直接创建图片节点并插入，确保Base64完整
                const img = document.createElement('img');
                img.src = event.target.result; // 完整Base64地址
                img.style.maxWidth = '100%';
                img.style.margin = '1rem 0';
                img.alt = '新闻配图';

                // 确保插入到光标位置
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.collapse(true); // 确保光标位置正确
                    range.insertNode(img);
                    // 移动光标到图片后
                    const newRange = document.createRange();
                    newRange.setStartAfter(img);
                    newRange.setEndAfter(img);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                } else {
                    contentEditor.appendChild(img);
                }

                uploadStatus.textContent = '✅ 图片上传成功';
                uploadStatus.classList.add('text-green-500');
                imageUpload.value = ''; // 重置文件选择
                setTimeout(() => {
                    uploadStatus.textContent = '';
                    uploadStatus.classList.remove('text-green-500');
                }, 3000);
            };
            // 读取为Base64（关键：确保完整编码）
            reader.readAsDataURL(file);
        });

        // 通用格式化函数
        function applyFormat(command) {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            
            const range = selection.getRangeAt(0);
            const selectedContent = range.extractContents();
            
            const span = document.createElement('span');
            if (command === 'bold') span.style.fontWeight = 'bold';
            if (command === 'italic') span.style.fontStyle = 'italic';
            
            span.appendChild(selectedContent);
            range.insertNode(span);
            range.selectNodeContents(span);
            selection.removeAllRanges();
            selection.addRange(range);
        }

        // 发布新闻功能（核心：完整保存HTML内容，包含图片Base64）
        publishBtn.addEventListener('click', () => {
            console.log('发布按钮被点击！');
            const category = newsCategory.value.trim();
            const title = newsTitle.value.trim();
            // 核心：直接获取编辑区完整HTML，不做多余过滤
            const content = contentEditor.innerHTML.trim();

            // 校验
            if (!title) {
                alert('❌ 请输入新闻标题');
                newsTitle.focus();
                return;
            }
            if (!content) {
                alert('❌ 请输入新闻内容');
                contentEditor.focus();
                return;
            }

            // 构建新闻数据（完整保存分类、标题、HTML内容）
            const newNews = {
                id: Date.now(),
                category: category,
                title: title,
                content: content, // 完整HTML，包含图片Base64
                publishTime: new Date().toLocaleString('zh-CN', { 
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                }),
                likeCount: 0,
                comments: []
            };

            try {
                // 保存到localStorage
                newsData.unshift(newNews);
                localStorage.setItem('newsData', JSON.stringify(newsData));
                console.log('发布成功，数据：', newNews);

                // 重置表单
                newsTitle.value = '';
                contentEditor.innerHTML = '';
                newsCategory.selectedIndex = 0;

                // 刷新列表
                renderNewsList();

                alert('✅ 新闻发布成功！图片已同步到读者端');
            } catch (error) {
                console.error('发布失败：', error);
                alert('❌ 发布失败：' + error.message);
            }
        });

        // 渲染已发布新闻列表
        function renderNewsList() {
            if (newsData.length === 0) {
                newsList.innerHTML = '<p class="text-gray-500 text-center py-8">暂无已发布新闻</p>';
                return;
            }

            newsList.innerHTML = '';
            newsData.forEach(news => {
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item p-4 border border-gray-200 rounded-lg';
                // 提取纯文本预览
                const plainContent = news.content.replace(/<[^>]+>/g, '').slice(0, 100);
                newsItem.innerHTML = `
                    <span class="inline-block px-2 py-1 bg-${getCategoryColor(news.category)} text-white text-xs rounded-full mb-2">${news.category}</span>
                    <h3 class="font-medium text-gray-800 mb-1">${news.title}</h3>
                    <div class="text-sm text-gray-500 mb-2">
                        发布时间：${news.publishTime} | 
                        点赞数：${news.likeCount} | 
                        评论数：${news.comments.length}
                    </div>
                    <div class="text-xs text-gray-400">
                        内容预览：${plainContent}...
                    </div>
                `;
                newsList.appendChild(newsItem);
            });
        }

        // 分类颜色映射
        function getCategoryColor(category) {
            const colors = {
                家居: 'brown-500',
                运动: 'green-500',
                商业: 'blue-500',
                创新: 'purple-500',
                文化: 'orange-500',
                艺术: 'pink-500',
                旅行: 'teal-500',
                地球: 'indigo-500'
            };
            return colors[category] || 'gray-500';
        }

        // 监听localStorage变化
        window.addEventListener('storage', (e) => {
            if (e.key === 'newsData') {
                newsData = JSON.parse(e.newValue) || [];
                renderNewsList();
            }
        });

        // 初始化渲染
        renderNewsList();
    </script>
</body>
</html>



