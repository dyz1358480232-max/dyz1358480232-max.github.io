<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新闻创作者平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .editor-toolbar button:hover {
            @apply bg-blue-100;
        }
        .news-item:hover {
            @apply shadow-lg transform -translate-y-1 transition-all;
        }
        /* 修复：用 CSS 实现富文本编辑器占位符 */
        #contentEditor:empty:before {
            content: '请输入新闻内容（必填，支持图文混排）';
            color: #9ca3af; /* 灰色占位符 */
            pointer-events: none; /* 点击时穿透占位符 */
        }
        #contentEditor {
            outline: none; /* 清除默认聚焦边框 */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600">新闻创作者平台</h1>
            <p class="text-gray-500">发布新闻，实时同步到读者端</p>
        </div>
    </header>

    <!-- 主体内容区 -->
    <main class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- 左侧：富文本编辑器 -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">发布新闻</h2>
                
                <!-- 新闻标题输入框 -->
                <input 
                    type="text" 
                    id="newsTitle" 
                    placeholder="请输入新闻标题（必填）" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                
                <!-- 富文本工具栏 -->
                <div class="editor-toolbar flex gap-2 mb-4 px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
                    <button id="boldBtn" class="px-3 py-1 border border-gray-300 rounded hover:cursor-pointer">
                        <b>B</b>
                    </button>
                    <button id="italicBtn" class="px-3 py-1 border border-gray-300 rounded hover:cursor-pointer">
                        <i>I</i>
                    </button>
                    <button id="fontSizeBtn" class="px-3 py-1 border border-gray-300 rounded hover:cursor-pointer">
                        Aa
                    </button>
                    <div class="h-6 w-px bg-gray-300 mx-1"></div>
                    <label for="imageUpload" class="px-3 py-1 bg-blue-500 text-white rounded hover:cursor-pointer">
                        上传图片
                    </label>
                    <input type="file" id="imageUpload" accept="image/*" class="hidden">
                    <span id="uploadStatus" class="ml-2 text-sm text-gray-500"></span>
                </div>
                
                <!-- 富文本编辑区（移除默认innerHTML占位符） -->
                <div 
                    id="contentEditor" 
                    contenteditable="true" 
                    class="w-full min-h-[300px] px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                ></div>
                
                <!-- 发布按钮 -->
                <button id="publishBtn" class="mt-6 w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    发布新闻
                </button>
            </div>

            <!-- 右侧：已发布新闻列表 -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">已发布新闻</h2>
                <div id="newsList" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
                    <p class="text-gray-500 text-center py-8">暂无已发布新闻</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // 1. 初始化数据
        let newsData = JSON.parse(localStorage.getItem('newsData')) || [];

        // 2. DOM元素获取
        const newsTitle = document.getElementById('newsTitle');
        const contentEditor = document.getElementById('contentEditor');
        const boldBtn = document.getElementById('boldBtn');
        const italicBtn = document.getElementById('italicBtn');
        const fontSizeBtn = document.getElementById('fontSizeBtn');
        const imageUpload = document.getElementById('imageUpload');
        const uploadStatus = document.getElementById('uploadStatus');
        const publishBtn = document.getElementById('publishBtn');
        const newsList = document.getElementById('newsList');

        // 3. 修复：富文本功能（替换废弃的 document.execCommand）
        // 加粗
        boldBtn.addEventListener('click', () => {
            applyFormat('bold');
            contentEditor.focus();
        });
        // 斜体
        italicBtn.addEventListener('click', () => {
            applyFormat('italic');
            contentEditor.focus();
        });
        // 字体大小切换
        fontSizeBtn.addEventListener('click', () => {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            
            const range = selection.getRangeAt(0);
            const selectedContent = range.extractContents();
            
            const span = document.createElement('span');
            // 切换字体大小（16px ↔ 20px ↔ 24px）
            const currentSize = parseInt(window.getComputedStyle(selectedContent.firstChild || span).fontSize) || 16;
            const newSize = currentSize === 16 ? 20 : currentSize === 20 ? 24 : 16;
            span.style.fontSize = `${newSize}px`;
            
            span.appendChild(selectedContent);
            range.insertNode(span);
            range.selectNodeContents(span);
            selection.removeAllRanges();
            selection.addRange(range);
            
            contentEditor.focus();
        });

        // 通用格式化函数（替代 document.execCommand）
        function applyFormat(command) {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            
            const range = selection.getRangeAt(0);
            const selectedContent = range.extractContents();
            
            const span = document.createElement('span');
            if (command === 'bold') span.style.fontWeight = 'bold';
            if (command === 'italic') span.style.fontStyle = 'italic';
            
            span.appendChild(selectedContent);
            range.insertNode(span);
            range.selectNodeContents(span);
            selection.removeAllRanges();
            selection.addRange(range);
        }

        // 4. 图片上传功能（保持不变）
        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                uploadStatus.textContent = '❌ 请上传图片文件（jpg/png/gif）';
                uploadStatus.classList.add('text-red-500');
                setTimeout(() => {
                    uploadStatus.textContent = '';
                    uploadStatus.classList.remove('text-red-500');
                }, 3000);
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = document.createElement('img');
                img.src = event.target.result;
                img.style.maxWidth = '100%';
                img.style.margin = '1rem 0';

                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(img);
                    range.setStartAfter(img);
                    range.setEndAfter(img);
                    selection.removeAllRanges();
                    selection.addRange(range);
                } else {
                    contentEditor.appendChild(img);
                }

                uploadStatus.textContent = '✅ 图片上传成功';
                uploadStatus.classList.add('text-green-500');
                imageUpload.value = '';
                setTimeout(() => {
                    uploadStatus.textContent = '';
                    uploadStatus.classList.remove('text-green-500');
                }, 3000);
            };
            reader.readAsDataURL(file);
        });

        // 5. 修复：发布新闻功能（加调试日志 + 优化校验）
        publishBtn.addEventListener('click', () => {
            console.log('发布按钮被点击了！'); // 调试日志
            const title = newsTitle.value.trim();
            // 优化：移除编辑区的空标签和占位符文本
            const content = contentEditor.innerHTML
                .replace(/<div><br><\/div>/g, '') // 移除空行
                .replace(/<div>请输入新闻内容.*<\/div>/g, '') // 移除残留占位符
                .trim();

            console.log('标题：', title, '内容：', content); // 查看输入内容

            // 校验必填项
            if (!title) {
                alert('❌ 请输入新闻标题');
                newsTitle.focus();
                return;
            }
            if (!content) {
                alert('❌ 请输入新闻内容');
                contentEditor.focus();
                return;
            }

            // 构建新闻数据
            const newNews = {
                id: Date.now(),
                title: title,
                content: content,
                publishTime: new Date().toLocaleString('zh-CN', { 
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                }),
                likeCount: 0,
                comments: []
            };

            // 保存到localStorage（加容错处理）
            try {
                newsData.unshift(newNews);
                localStorage.setItem('newsData', JSON.stringify(newsData));
                console.log('数据保存成功：', newsData); // 调试日志

                // 重置编辑器
                newsTitle.value = '';
                contentEditor.innerHTML = '';

                // 刷新列表
                renderNewsList();

                alert('✅ 新闻发布成功！已实时同步到读者端');
            } catch (error) {
                console.error('发布失败：', error); // 打印错误
                alert('❌ 发布失败：' + error.message);
            }
        });

        // 6. 渲染已发布新闻列表（保持不变）
        function renderNewsList() {
            if (newsData.length === 0) {
                newsList.innerHTML = '<p class="text-gray-500 text-center py-8">暂无已发布新闻</p>';
                return;
            }

            newsList.innerHTML = '';
            newsData.forEach(news => {
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item p-4 border border-gray-200 rounded-lg';
                newsItem.innerHTML = `
                    <h3 class="font-medium text-gray-800 mb-1">${news.title}</h3>
                    <div class="text-sm text-gray-500 mb-2">
                        发布时间：${news.publishTime} | 
                        点赞数：${news.likeCount} | 
                        评论数：${news.comments.length}
                    </div>
                    <div class="text-xs text-gray-400">
                        内容预览：${news.content.replace(/<[^>]+>/g, '').slice(0, 100)}...
                    </div>
                `;
                newsList.appendChild(newsItem);
            });
        }

        // 7. 监听localStorage变化（保持不变）
        window.addEventListener('storage', (e) => {
            if (e.key === 'newsData') {
                newsData = JSON.parse(e.newValue) || [];
                renderNewsList();
            }
        });

        // 8. 页面加载时渲染新闻列表（保持不变）
        renderNewsList();
    </script>
</body>
</html>
